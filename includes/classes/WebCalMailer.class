<?php
/**
 * Class to over load PHPMailer class to utilize
 * WebCalendar's translation function
 *
 * PHPMailer's homepage http://phpmailer.sourceforge.net/
 *
 *
 * @author Ray Jones <rjones@umces.edu>
 * @copyright Craig Knudsen, <cknudsen@cknudsen.com>, http://www.k5n.us/cknudsen
 * @license http://www.gnu.org/licenses/gpl.html GNU GPL
 * @version $Id$
 * @package WebCalendar
 * @subpackage Mailer
 *
 */
$inc_path = ( !empty ( $includedir )?  $includedir : "includes" ); 
if ( file_exists ( "$inc_path/xcal.php" ) )
  include_once "$inc_path/xcal.php"; //used for ics attachments
require("phpmailer/class.phpmailer.php");

class WebCalMailer extends phpmailer { 

  var $WordWrap = 75;

  //constructor function
  function WebCalMailer () {
    global $APPLICATION_NAME, $SMTP_HOST, $SMTP_AUTH,
      $SMTP_USERNAME, $SMTP_PASSWORD, $EMAIL_MAILER;
    $this->Version .= " extended by " . translate($APPLICATION_NAME);
    $this->Host     = $SMTP_HOST;
    $this->Mailer   = $EMAIL_MAILER;
    $this->CharSet  = translate ( "charset");
    $mail->SMTPAuth = ( $SMTP_AUTH == 'Y'? true : false );     // turn on SMTP authentication
    $mail->Username = $SMTP_USERNAME;  // SMTP username
    $mail->Password = $SMTP_PASSWORD; // SMTP password 
  }
  
  // Replace the default language handler to use WebCalendar's function
  function Lang($key) {
    //we can't put ":" in translations, so we use "~"
    return  str_replace ( "~", ": ", translate ( $key ) ); 
  }

  //Replace the default error handler so we can add our own trailer
  function SetError($msg) {
    $this->error_count++;
    //$this->ErrorInfo = $msg;
    die_miserable_death ( $msg );
  }
  
  //Strip slashes from subject
  function WCSubject ($name) {
    global $APPLICATION_NAME;
    $this->Subject = translate($APPLICATION_NAME) . " " .
      translate("Notification", true) . ": " . stripslashes ( $name );  
  }

  //Send ics file Attachment
  function IcsAttach ($id) {
    if ( function_exists ('export_ical') )
      $this->AddStringAttachment ( export_ical ( $id, true ),
        'WebCalendar.ics', 'base64', 'text/ical' ) ;
  
  }
    
  //New function to clear ALL attributes
  function ClearAll () {
    $this->ClearAddresses();
    $this->ClearAllRecipients();    
    $this->ClearAttachments();
    $this->ClearCustomHeaders();      
  }
}

// The following comments will be picked up by update_translation.pl so
// translators will find them.
//
// translate ( "provide_address");
// translate ( "mailer_not_supported");
// translate ( "execute");
// translate ( "instantiate");
// translate ( "authenticate");
// translate ( "from_failed");
// translate ( "recipients_failed");
// translate ( "data_not_accepted");
// translate ( "connect_host");
// translate ( "file_access");
// translate ( "file_open");
// translate ( "encoding");


?>
